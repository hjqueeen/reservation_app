# 개발 환경용 Dockerfile
FROM node:24.13.0-alpine

WORKDIR /app

# 패키지 매니저 캐시를 위한 설정
RUN apk add --no-cache libc6-compat

# package.json 복사
COPY package.json ./

# 의존성 설치
RUN npm install

# 소스 코드는 docker-compose에서 볼륨으로 마운트되므로 여기서는 복사하지 않음

EXPOSE 3002

ENV PORT 3002
ENV HOSTNAME "0.0.0.0"

# Entrypoint 스크립트 생성
RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'if [ ! -d "node_modules" ] || [ -z "$(ls -A node_modules)" ]; then' >> /entrypoint.sh && \
    echo '  echo "Installing dependencies..."' >> /entrypoint.sh && \
    echo '  npm install' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo 'exec "$@"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]

# 개발 서버 실행
CMD ["npm", "run", "dev"]
